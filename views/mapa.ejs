<%- include ('partials/header.ejs') %>
<%- include('partials/navbar-user.ejs') %>
<main class="main-content home-dashboard">
    <%- include ('partials/navbar-lateral.ejs') %>
    <section class="dashboard-container">
        <header class="dashboard-header">
            <h1>Mapa</h1>
            <div class="property-select">
                <label for="propriedades">Propriedade</label>
                <div class="select-wrapper">
                    <% if (Propriedades && Propriedades.length > 0) { %>
                        <select id="propriedades" class="property-dropdown">
                            <% Propriedades.forEach(prop => { %>
                                <option value="<%= prop.id_propriedade %>" <%= propriedadeSelecionada == prop.id_propriedade ? 'selected' : '' %>><%= prop.nome %></option>
                            <% }) %>
                        </select>
                    <% } else { %>
                        <select id="propriedades" class="property-dropdown" disabled>
                            <option>Nenhuma propriedade cadastrada</option>
                        </select>
                    <% } %>
                </div>
            </div>
        </header>

        <section class="analysis-section">
            <div class="analysis-card" style="margin-bottom: 24px; padding: 0;">
                <div class="card-body" style="padding: 0;">
                    <div id="map" style="width: 100%; height: 600px; border-radius: 12px;"></div>
                </div>
            </div>

            <div class="analysis-card analysis-card-custom">
                <header class="card-header card-header-custom">
                    <div class="card-header-custom-top">
                        <h3>Marcadores no Mapa</h3>
                    </div>
                    <div class="card-header-divider"></div>
                </header>
                <div class="card-body card-body-custom">
                    <table class="table-custom">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Nome</th>
                                <th>Localização</th>
                                <th style="width: 100px;"></th>
                            </tr>
                        </thead>
                        <tbody id="marcadores-table">
                            <!-- Será preenchido via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </section>
</main>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Dados do servidor
    const propriedades = <%- JSON.stringify(Propriedades) %>;
    const propriedadeSelecionada = '<%= propriedadeSelecionada || "" %>';
    const alqueires = <%- alqueires %>;
    const talhoes = <%- talhoes %>;
    const pes = <%- pes %>;
    
    // Armazenar todos os marcadores para controle
    const marcadores = new Map();
    const marcadoresData = [];
    
    // Determinar centro inicial do mapa
    let mapCenter = [-24.7150037, -47.9281331];
    let mapZoom = 12;
    
    if (propriedadeSelecionada) {
        const propriedade = propriedades.find(p => p.id_propriedade == propriedadeSelecionada);
        if (propriedade && propriedade.latitude && propriedade.longitude) {
            mapCenter = [parseFloat(propriedade.latitude), parseFloat(propriedade.longitude)];
            mapZoom = 15;
        }
    }

    // Inicializa mapa
    const map = L.map('map').setView(mapCenter, mapZoom);

    // Adiciona layer Satelite da ESRI
    const satelite = L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        { attribution: 'Tiles © Esri' }
    );

    // Adiciona layer OpenStreetMap
    const osm = L.tileLayer(
        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        { attribution: '© OpenStreetMap' }
    );

    satelite.addTo(map);

    // Controle para alternar mapa/satelite
    L.control.layers({
        "Satelite": satelite,
        "Mapa": osm
    }).addTo(map);

    // Ícones personalizados
    const propriedadeIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    
    const alqueireIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    
    const talhaoIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    
    const peIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [20, 35],
        iconAnchor: [10, 35],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    // Função para adicionar propriedades
    propriedades.forEach(prop => {
        if (prop.latitude && prop.longitude) {
            const marker = L.marker([parseFloat(prop.latitude), parseFloat(prop.longitude)], { icon: propriedadeIcon })
                .addTo(map)
                .bindPopup(`
                    <strong>Propriedade: ${prop.nome}</strong><br>
                    ${prop.logradouro}, ${prop.numero}<br>
                    ${prop.bairro} - ${prop.cidade}<br>
                    CEP: ${prop.cep}
                `);
            
            const key = `prop_${prop.id_propriedade}`;
            marcadores.set(key, marker);
            marcadoresData.push({
                key: key,
                tipo: 'Propriedade',
                nome: prop.nome,
                lat: parseFloat(prop.latitude),
                lng: parseFloat(prop.longitude),
                marker: marker
            });
        }
    });

    // Função para adicionar alqueires
    alqueires.forEach(alq => {
        if (alq.latitude && alq.longitude) {
            const marker = L.marker([parseFloat(alq.latitude), parseFloat(alq.longitude)], { icon: alqueireIcon })
                .addTo(map)
                .bindPopup(`
                    <strong>Alqueire: ${alq.nome}</strong><br>
                    Área: ${alq.area_total || '-'} ha
                `);
            
            const key = `alq_${alq.id_alqueire}`;
            marcadores.set(key, marker);
            marcadoresData.push({
                key: key,
                tipo: 'Alqueire',
                nome: alq.nome,
                lat: parseFloat(alq.latitude),
                lng: parseFloat(alq.longitude),
                marker: marker
            });
        }
        
        // Adicionar polígono se existir
        if (alq.coordenadas_poligono) {
            try {
                const coords = JSON.parse(alq.coordenadas_poligono);
                if (Array.isArray(coords) && coords.length > 0) {
                    const latlngs = coords.map(c => [c.lat, c.lng]);
                    const polygon = L.polygon(latlngs, {
                        color: '#0284E1',
                        fillColor: '#0284E1',
                        fillOpacity: 0.3,
                        weight: 2
                    }).addTo(map)
                    .bindPopup(`<strong>Alqueire: ${alq.nome}</strong><br>Área: ${alq.area_total || '-'} ha`);
                    
                    // Adicionar polígono aos marcadores para controle
                    const key = `alq_poly_${alq.id_alqueire}`;
                    marcadores.set(key, polygon);
                }
            } catch (e) {
                console.error('Erro ao parsear coordenadas do alqueire:', e);
            }
        }
    });

    // Função para adicionar talhões
    talhoes.forEach(tal => {
        if (tal.latitude && tal.longitude) {
            const marker = L.marker([parseFloat(tal.latitude), parseFloat(tal.longitude)], { icon: talhaoIcon })
                .addTo(map)
                .bindPopup(`
                    <strong>Talhão: ${tal.nome}</strong><br>
                    Espécie: ${tal.especie_fruta || '-'}
                `);
            
            const key = `tal_${tal.id_talhao}`;
            marcadores.set(key, marker);
            marcadoresData.push({
                key: key,
                tipo: 'Talhão',
                nome: tal.nome,
                lat: parseFloat(tal.latitude),
                lng: parseFloat(tal.longitude),
                marker: marker
            });
        }
        
        // Adicionar polígono se existir
        if (tal.coordenadas_poligono) {
            try {
                const coords = JSON.parse(tal.coordenadas_poligono);
                if (Array.isArray(coords) && coords.length > 0) {
                    const latlngs = coords.map(c => [c.lat, c.lng]);
                    const polygon = L.polygon(latlngs, {
                        color: '#65B741',
                        fillColor: '#65B741',
                        fillOpacity: 0.3,
                        weight: 2
                    }).addTo(map)
                    .bindPopup(`<strong>Talhão: ${tal.nome}</strong><br>Espécie: ${tal.especie_fruta || '-'}`);
                    
                    // Adicionar polígono aos marcadores para controle
                    const key = `tal_poly_${tal.id_talhao}`;
                    marcadores.set(key, polygon);
                }
            } catch (e) {
                console.error('Erro ao parsear coordenadas do talhão:', e);
            }
        }
    });

    // Função para adicionar pés
    pes.forEach(pe => {
        if (pe.latitude && pe.longitude) {
            let situacaoTexto = 'Sem informações';
            if (pe.situacao === 'Tratado') {
                situacaoTexto = 'Tratado';
            } else if (pe.situacao === 'Não-Tratado') {
                situacaoTexto = 'Não-Tratado';
            }
            
            let deficiencias = [];
            if (pe.deficiencia_cobre) deficiencias.push('Cobre');
            if (pe.deficiencia_manganes) deficiencias.push('Manganês');
            if (pe.outros) deficiencias.push('Outros');
            const deficienciasTexto = deficiencias.length > 0 ? deficiencias.join(', ') : 'Nenhuma';
            
            const marker = L.marker([parseFloat(pe.latitude), parseFloat(pe.longitude)], { icon: peIcon })
                .addTo(map)
                .bindPopup(`
                    <strong>Pé: ${pe.nome}</strong><br>
                    <strong>Situação:</strong> ${situacaoTexto}<br>
                    <strong>Deficiências:</strong> ${deficienciasTexto}<br>
                    ${pe.observacoes ? `<strong>Obs:</strong> ${pe.observacoes}` : ''}
                `);
            
            const key = `pe_${pe.id_pe}`;
            marcadores.set(key, marker);
            marcadoresData.push({
                key: key,
                tipo: 'Pé',
                nome: pe.nome,
                lat: parseFloat(pe.latitude),
                lng: parseFloat(pe.longitude),
                marker: marker,
                situacao: situacaoTexto,
                deficiencias: deficienciasTexto
            });
        }
    });

    // Função para atualizar tabela de marcadores
    function atualizarTabelaMarcadores() {
        const tbody = document.getElementById('marcadores-table');
        tbody.innerHTML = '';
        
        if (marcadoresData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="empty-state-custom"><p>Nenhum marcador encontrado</p></td></tr>';
            return;
        }
        
        marcadoresData.forEach(item => {
            const row = document.createElement('tr');
            row.style.cursor = 'pointer';
            row.onmouseover = () => row.style.backgroundColor = '#FAF0D7';
            row.onmouseout = () => row.style.backgroundColor = '';
            
            const tipoBadge = item.tipo === 'Propriedade' ? '#D84A0F' : 
                             item.tipo === 'Alqueire' ? '#0284E1' : 
                             item.tipo === 'Talhão' ? '#65B741' : '#FFB534';
            
            row.innerHTML = `
                <td>
                    <span style="display: inline-block; width: 12px; height: 12px; background-color: ${tipoBadge}; border-radius: 50%; margin-right: 8px;"></span>
                    ${item.tipo}
                </td>
                <td>${item.nome}</td>
                <td>${item.lat.toFixed(6)}, ${item.lng.toFixed(6)}</td>
                <td class="text-center">
                    <button onclick="mostrarNoMapa('${item.key}')" style="background: #65B741; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                        Ver no Mapa
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }

    // Função para mostrar marcador no mapa com zoom
    window.mostrarNoMapa = function(key) {
        const item = marcadoresData.find(m => m.key === key);
        if (item && item.marker) {
            // Fazer scroll para o topo do mapa
            const mapElement = document.getElementById('map');
            if (mapElement) {
                mapElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // Pequeno delay para garantir que o scroll aconteceu
            setTimeout(() => {
                map.setView([item.lat, item.lng], 18);
                item.marker.openPopup();
                
                // Destacar o marcador
                if (item.marker.setIcon) {
                    const originalIcon = item.marker.options.icon;
                    const highlightIcon = L.icon({
                        iconUrl: originalIcon.options.iconUrl,
                        shadowUrl: originalIcon.options.shadowUrl,
                        iconSize: [35, 50],
                        iconAnchor: [17, 50],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });
                    item.marker.setIcon(highlightIcon);
                    
                    setTimeout(() => {
                        item.marker.setIcon(originalIcon);
                    }, 2000);
                }
            }, 300);
        }
    };

    // Inicializar tabela
    atualizarTabelaMarcadores();

    // Atualizar mapa quando propriedade for alterada
    const propriedadesSelect = document.getElementById('propriedades');
    if (propriedadesSelect) {
        propriedadesSelect.addEventListener('change', async function() {
            const idPropriedade = this.value;
            
            // Atualizar sessão
            try {
                await fetch('/mapa/selecionar-propriedade', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id_propriedade: idPropriedade })
                });
            } catch (error) {
                console.error('Erro ao atualizar sessão:', error);
            }
            
            try {
                const response = await fetch('/mapa/dados-propriedade/' + idPropriedade, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Limpar mapa e dados
                    map.eachLayer(function(layer) {
                        if (layer instanceof L.Marker || layer instanceof L.Polygon) {
                            map.removeLayer(layer);
                        }
                    });
                    
                    marcadores.clear();
                    marcadoresData.length = 0;
                    
                    // Adicionar nova propriedade
                    if (data.propriedade && data.propriedade.latitude && data.propriedade.longitude) {
                        map.setView([parseFloat(data.propriedade.latitude), parseFloat(data.propriedade.longitude)], 15);
                        
                        const marker = L.marker([parseFloat(data.propriedade.latitude), parseFloat(data.propriedade.longitude)], { icon: propriedadeIcon })
                            .addTo(map)
                            .bindPopup(`
                                <strong>Propriedade: ${data.propriedade.nome}</strong><br>
                                ${data.propriedade.logradouro}, ${data.propriedade.numero}<br>
                                ${data.propriedade.bairro} - ${data.propriedade.cidade}
                            `);
                        
                        const key = `prop_${data.propriedade.id_propriedade}`;
                        marcadores.set(key, marker);
                        marcadoresData.push({
                            key: key,
                            tipo: 'Propriedade',
                            nome: data.propriedade.nome,
                            lat: parseFloat(data.propriedade.latitude),
                            lng: parseFloat(data.propriedade.longitude),
                            marker: marker
                        });
                    }
                    
                    // Adicionar alqueires
                    data.alqueires.forEach(alq => {
                        if (alq.latitude && alq.longitude) {
                            const marker = L.marker([parseFloat(alq.latitude), parseFloat(alq.longitude)], { icon: alqueireIcon })
                                .addTo(map)
                                .bindPopup(`<strong>Alqueire: ${alq.nome}</strong>`);
                            
                            const key = `alq_${alq.id_alqueire}`;
                            marcadores.set(key, marker);
                            marcadoresData.push({
                                key: key,
                                tipo: 'Alqueire',
                                nome: alq.nome,
                                lat: parseFloat(alq.latitude),
                                lng: parseFloat(alq.longitude),
                                marker: marker
                            });
                        }
                        
                        // Adicionar polígono se existir
                        if (alq.coordenadas_poligono) {
                            try {
                                const coords = JSON.parse(alq.coordenadas_poligono);
                                if (Array.isArray(coords) && coords.length > 0) {
                                    const latlngs = coords.map(c => [c.lat, c.lng]);
                                    const polygon = L.polygon(latlngs, {
                                        color: '#0284E1',
                                        fillColor: '#0284E1',
                                        fillOpacity: 0.3,
                                        weight: 2
                                    }).addTo(map)
                                    .bindPopup(`<strong>Alqueire: ${alq.nome}</strong><br>Área: ${alq.area_total || '-'} ha`);
                                    
                                    const key = `alq_poly_${alq.id_alqueire}`;
                                    marcadores.set(key, polygon);
                                }
                            } catch (e) {
                                console.error('Erro ao parsear coordenadas do alqueire:', e);
                            }
                        }
                    });
                    
                    // Adicionar talhões
                    data.talhoes.forEach(tal => {
                        if (tal.latitude && tal.longitude) {
                            const marker = L.marker([parseFloat(tal.latitude), parseFloat(tal.longitude)], { icon: talhaoIcon })
                                .addTo(map)
                                .bindPopup(`<strong>Talhão: ${tal.nome}</strong>`);
                            
                            const key = `tal_${tal.id_talhao}`;
                            marcadores.set(key, marker);
                            marcadoresData.push({
                                key: key,
                                tipo: 'Talhão',
                                nome: tal.nome,
                                lat: parseFloat(tal.latitude),
                                lng: parseFloat(tal.longitude),
                                marker: marker
                            });
                        }
                        
                        // Adicionar polígono se existir
                        if (tal.coordenadas_poligono) {
                            try {
                                const coords = JSON.parse(tal.coordenadas_poligono);
                                if (Array.isArray(coords) && coords.length > 0) {
                                    const latlngs = coords.map(c => [c.lat, c.lng]);
                                    const polygon = L.polygon(latlngs, {
                                        color: '#65B741',
                                        fillColor: '#65B741',
                                        fillOpacity: 0.3,
                                        weight: 2
                                    }).addTo(map)
                                    .bindPopup(`<strong>Talhão: ${tal.nome}</strong><br>Espécie: ${tal.especie_fruta || '-'}`);
                                    
                                    const key = `tal_poly_${tal.id_talhao}`;
                                    marcadores.set(key, polygon);
                                }
                            } catch (e) {
                                console.error('Erro ao parsear coordenadas do talhão:', e);
                            }
                        }
                    });
                    
                    // Adicionar pés
                    data.pes.forEach(pe => {
                        if (pe.latitude && pe.longitude) {
                            let situacaoTexto = 'Sem informações';
                            if (pe.situacao === 'Tratado') {
                                situacaoTexto = 'Tratado';
                            } else if (pe.situacao === 'Não-Tratado') {
                                situacaoTexto = 'Não-Tratado';
                            }
                            
                            let deficiencias = [];
                            if (pe.deficiencia_cobre) deficiencias.push('Cobre');
                            if (pe.deficiencia_manganes) deficiencias.push('Manganês');
                            if (pe.outros) deficiencias.push('Outros');
                            const deficienciasTexto = deficiencias.length > 0 ? deficiencias.join(', ') : 'Nenhuma';
                            
                            const marker = L.marker([parseFloat(pe.latitude), parseFloat(pe.longitude)], { icon: peIcon })
                                .addTo(map)
                                .bindPopup(`
                                    <strong>Pé: ${pe.nome}</strong><br>
                                    <strong>Situação:</strong> ${situacaoTexto}<br>
                                    <strong>Deficiências:</strong> ${deficienciasTexto}<br>
                                    ${pe.observacoes ? `<strong>Obs:</strong> ${pe.observacoes}` : ''}
                                `);
                            
                            const key = `pe_${pe.id_pe}`;
                            marcadores.set(key, marker);
                            marcadoresData.push({
                                key: key,
                                tipo: 'Pé',
                                nome: pe.nome,
                                lat: parseFloat(pe.latitude),
                                lng: parseFloat(pe.longitude),
                                marker: marker,
                                situacao: situacaoTexto,
                                deficiencias: deficienciasTexto
                            });
                        }
                    });
                    
                    atualizarTabelaMarcadores();
                }
            } catch (error) {
                console.error('Erro ao carregar dados da propriedade:', error);
            }
        });
    }
});
</script>

<%- include ('partials/footer.ejs') %>
