<%- include ('partials/header.ejs') %>
<%- include('partials/navbar-user.ejs') %>
<main class="main-content">
    <%- include ('partials/navbar-lateral.ejs') %>  
    <div class="container cont">     
        <div class="container">
            <div class="d-flex align-items-center justify-content-between mt-2" id="hist">
                <h2 class="align-self-end m-0 p-0 fonte titulo1">Mapas</h2>
                <div id="options-container">
                    <select id="propriedades" class="options">
                        <% Propriedades.forEach(prop => {%>
                            <option value="<%= prop.id_propriedade%>" <%= propriedadeSelecionada == prop.id_propriedade ? 'selected' : '' %>><%= prop.nome%></option>
                        <%})%>
                    </select>
                    <img src="/imgs/seta-prop.svg" alt="Seta" class="menu-arrowp" id="setajs"/>
                </div>
            </div>
            <img src="/imgs/linha.png" alt="" id="voltar-linha" class="p-0 mt-0" />
        </div>
        
        <div class="container pt-3">
            <div class="map-container-wrapper" style="background: #FAF0D7; border-radius: 14px; padding: 24px; margin-bottom: 24px;">
                <div class="custom-menu" tabindex="0" style="margin-bottom: 20px;">
                    <div class="menu-header">
                        <span class="menu-selected">Mapa Imagem de Satélite</span>
                        <img src="/imgs/arrow-down.svg" alt="Seta" class="menu-arrow" />
                    </div>
                    <ul class="menu-options">
                        <li class="menu-option" data-value="satellite">Mapa Imagem de Satélite</li>
                        <li class="menu-option" data-value="roadmap">Mapa Localização Pés (Apex)</li>
                        <li class="menu-option" data-value="heatmap">Mapa de Calor (Apex)</li>
                        <li class="menu-option" data-value="ndvi">Mapa Infravermelho (NDVI)</li>
                    </ul>
                </div>
                
                <div class="map-and-info-container">
                    <div class="map-wrapper" style="background: white; border-radius: 14px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div id="map" style="width: 100%; height: 600px; border-radius: 12px; border: 2px solid #F2C48D;"></div>
                        <div id="info-box" class="map-info-box" style="display: none;">
                            <div class="info-box-header">
                                <strong id="info-box-title"></strong>
                            </div>
                            <div class="info-box-body">
                                <div id="info-box-address"></div>
                                <div class="info-box-actions">
                                    <a href="#" id="info-box-link" target="_blank">Ver mapa ampliado</a>
                                    <button id="info-box-routes" class="btn-routes">Rotas</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="property-info-panel" class="property-info-panel" style="display: none;">
                        <div class="panel-header">
                            <h3 id="panel-title">Mapa de Satélite</h3>
                        </div>
                        <div class="panel-body">
                            <div class="info-item">
                                <label>Região:</label>
                                <span id="panel-regiao">-</span>
                            </div>
                            <div class="info-item">
                                <label>Endereço:</label>
                                <span id="panel-endereco">-</span>
                            </div>
                            <div class="info-item">
                                <label>CEP:</label>
                                <span id="panel-cep">-</span>
                            </div>
                            <div class="info-item">
                                <label>Data:</label>
                                <select id="panel-data" class="date-selector">
                                    <option>25 de Maio de 2024 (25/05/2024)</option>
                                </select>
                            </div>
                            <button id="panel-expand" class="btn-expand">
                                <span>Expandir</span>
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M6 2L2 6M2 6L6 10M2 6H14M10 14L14 10M14 10L10 6M14 10H2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<style>
.map-container-wrapper {
    margin-top: 20px;
    background: #FAF0D7;
    border-radius: 14px;
    padding: 24px;
}

.map-container-wrapper .custom-menu .menu-header {
    background-color: white;
    border: 2px solid #F2C48D;
    border-radius: 12px;
}

.map-container-wrapper .custom-menu.open .menu-header {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
    border-bottom: none;
}

.map-container-wrapper .custom-menu .menu-options {
    background-color: white;
    border: 2px solid #F2C48D;
    border-top: none;
    border-radius: 0 0 12px 12px;
}

.map-and-info-container {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}

.map-wrapper {
    flex: 1;
    position: relative;
}

.map-info-box {
    position: absolute;
    top: 10px;
    left: 10px;
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    z-index: 1000;
    max-width: 300px;
}

.info-box-header {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
    color: #351102;
}

.info-box-body {
    font-size: 14px;
    color: #666;
}

.info-box-actions {
    margin-top: 10px;
    display: flex;
    gap: 10px;
    align-items: center;
}

.info-box-actions a {
    color: #0284E1;
    text-decoration: none;
    font-size: 14px;
}

.info-box-actions a:hover {
    text-decoration: underline;
}

.btn-routes {
    background: #65B741;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.property-info-panel {
    width: 350px;
    background: white;
    border-radius: 14px;
    border: 2px solid #F2C48D;
    padding: 24px;
    height: fit-content;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.panel-header h3 {
    margin: 0 0 20px 0;
    font-size: 20px;
    font-weight: 700;
    color: #351102;
}

.panel-body {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.info-item label {
    font-size: 14px;
    color: #666;
    font-weight: 500;
}

.info-item span {
    font-size: 15px;
    color: #351102;
    font-weight: 600;
}

.date-selector {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    color: #351102;
}

.btn-expand {
    margin-top: 10px;
    background: #65B741;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    align-self: flex-end;
}

.btn-expand:hover {
    background: #5aa338;
}

@media (max-width: 1024px) {
    .map-and-info-container {
        flex-direction: column;
    }
    
    .property-info-panel {
        width: 100%;
    }
}
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Plugin para desenho de polígonos/edição -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css"/>
<script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    // Dados do servidor
    const propriedades = <%- JSON.stringify(Propriedades) %>;
    const propriedadeSelecionada = '<%= propriedadeSelecionada || "" %>';
    const alqueires = <%- alqueires %>;
    const talhoes = <%- talhoes %>;
    const pes = <%- pes %>;
    
    // Determinar centro inicial do mapa
    let mapCenter = [-24.7150037, -47.9281331];
    let mapZoom = 12;
    
    if (propriedadeSelecionada) {
        const propriedade = propriedades.find(p => p.id_propriedade == propriedadeSelecionada);
        if (propriedade && propriedade.latitude && propriedade.longitude) {
            mapCenter = [parseFloat(propriedade.latitude), parseFloat(propriedade.longitude)];
            mapZoom = 15;
        }
    }

    // ===== 1. Inicializa mapa =====
    const map = L.map('map').setView(mapCenter, mapZoom);

    // ===== 2. Adiciona layer Satelite da ESRI (grátis) =====
    const satelite = L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        { attribution: 'Tiles © Esri' }
    );

    // ===== 3. Adiciona layer OpenStreetMap (mapa comum) =====
    const osm = L.tileLayer(
        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        { attribution: '© OpenStreetMap' }
    );

    satelite.addTo(map);

    // Controle para alternar mapa/satelite
    L.control.layers({
        "Satelite": satelite,
        "Mapa": osm
    }).addTo(map);

    // ===== 4. Adicionar marcadores e polígonos dos cadastrados =====
    
    // Ícones personalizados
    const propriedadeIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    
    const alqueireIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    
    const talhaoIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });
    
    const peIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [20, 35],
        iconAnchor: [10, 35],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
    });

    // Função para adicionar propriedades
    propriedades.forEach(prop => {
        if (prop.latitude && prop.longitude) {
            L.marker([parseFloat(prop.latitude), parseFloat(prop.longitude)], { icon: propriedadeIcon })
                .addTo(map)
                .bindPopup(`
                    <strong>Propriedade: ${prop.nome}</strong><br>
                    ${prop.logradouro}, ${prop.numero}<br>
                    ${prop.bairro} - ${prop.cidade}<br>
                    CEP: ${prop.cep}
                `);
        }
    });

    // Função para adicionar alqueires
    alqueires.forEach(alq => {
        if (alq.latitude && alq.longitude) {
            L.marker([parseFloat(alq.latitude), parseFloat(alq.longitude)], { icon: alqueireIcon })
                .addTo(map)
                .bindPopup(`
                    <strong>Alqueire: ${alq.nome}</strong><br>
                    Área: ${alq.area_total || '-'} ha
                `);
        }
        
        // Adicionar polígono se existir
        if (alq.coordenadas_poligono) {
            try {
                const coords = JSON.parse(alq.coordenadas_poligono);
                if (Array.isArray(coords) && coords.length > 0) {
                    const latlngs = coords.map(c => [c.lat, c.lng]);
                    L.polygon(latlngs, {
                        color: '#0284E1',
                        fillColor: '#0284E1',
                        fillOpacity: 0.3,
                        weight: 2
                    }).addTo(map)
                    .bindPopup(`<strong>Alqueire: ${alq.nome}</strong><br>Área: ${alq.area_total || '-'} ha`);
                }
            } catch (e) {
                console.error('Erro ao parsear coordenadas do alqueire:', e);
            }
        }
    });

    // Função para adicionar talhões
    talhoes.forEach(tal => {
        if (tal.latitude && tal.longitude) {
            L.marker([parseFloat(tal.latitude), parseFloat(tal.longitude)], { icon: talhaoIcon })
                .addTo(map)
                .bindPopup(`
                    <strong>Talhão: ${tal.nome}</strong><br>
                    Espécie: ${tal.especie_fruta || '-'}
                `);
        }
        
        // Adicionar polígono se existir
        if (tal.coordenadas_poligono) {
            try {
                const coords = JSON.parse(tal.coordenadas_poligono);
                if (Array.isArray(coords) && coords.length > 0) {
                    const latlngs = coords.map(c => [c.lat, c.lng]);
                    L.polygon(latlngs, {
                        color: '#65B741',
                        fillColor: '#65B741',
                        fillOpacity: 0.3,
                        weight: 2
                    }).addTo(map)
                    .bindPopup(`<strong>Talhão: ${tal.nome}</strong><br>Espécie: ${tal.especie_fruta || '-'}`);
                }
            } catch (e) {
                console.error('Erro ao parsear coordenadas do talhão:', e);
            }
        }
    });

    // Função para adicionar pés
    pes.forEach(pe => {
        if (pe.latitude && pe.longitude) {
            L.marker([parseFloat(pe.latitude), parseFloat(pe.longitude)], { icon: peIcon })
                .addTo(map)
                .bindPopup(`
                    <strong>Pé: ${pe.nome}</strong><br>
                    ${pe.observacoes ? `Obs: ${pe.observacoes}` : ''}
                `);
        }
    });

    // Atualizar mapa quando propriedade for alterada
    const propriedadesSelect = document.getElementById('propriedades');
    if (propriedadesSelect) {
        propriedadesSelect.addEventListener('change', async function() {
            const idPropriedade = this.value;
            
            try {
                const response = await fetch('/mapa/dados-propriedade/' + idPropriedade, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Limpar mapa
                    map.eachLayer(function(layer) {
                        if (layer instanceof L.Marker || layer instanceof L.Polygon) {
                            map.removeLayer(layer);
                        }
                    });
                    
                    // Adicionar nova propriedade
                    if (data.propriedade && data.propriedade.latitude && data.propriedade.longitude) {
                        map.setView([parseFloat(data.propriedade.latitude), parseFloat(data.propriedade.longitude)], 15);
                        
                        L.marker([parseFloat(data.propriedade.latitude), parseFloat(data.propriedade.longitude)], { icon: propriedadeIcon })
                            .addTo(map)
                            .bindPopup(`
                                <strong>Propriedade: ${data.propriedade.nome}</strong><br>
                                ${data.propriedade.logradouro}, ${data.propriedade.numero}<br>
                                ${data.propriedade.bairro} - ${data.propriedade.cidade}
                            `);
                    }
                    
                    // Adicionar alqueires
                    data.alqueires.forEach(alq => {
                        if (alq.latitude && alq.longitude) {
                            L.marker([parseFloat(alq.latitude), parseFloat(alq.longitude)], { icon: alqueireIcon })
                                .addTo(map)
                                .bindPopup(`<strong>Alqueire: ${alq.nome}</strong>`);
                        }
                        if (alq.coordenadas_poligono) {
                            try {
                                const coords = JSON.parse(alq.coordenadas_poligono);
                                if (Array.isArray(coords) && coords.length > 0) {
                                    const latlngs = coords.map(c => [c.lat, c.lng]);
                                    L.polygon(latlngs, {
                                        color: '#0284E1',
                                        fillColor: '#0284E1',
                                        fillOpacity: 0.3,
                                        weight: 2
                                    }).addTo(map)
                                    .bindPopup(`<strong>Alqueire: ${alq.nome}</strong>`);
                                }
                            } catch (e) {
                                console.error('Erro ao parsear coordenadas:', e);
                            }
                        }
                    });
                    
                    // Adicionar talhões
                    data.talhoes.forEach(tal => {
                        if (tal.latitude && tal.longitude) {
                            L.marker([parseFloat(tal.latitude), parseFloat(tal.longitude)], { icon: talhaoIcon })
                                .addTo(map)
                                .bindPopup(`<strong>Talhão: ${tal.nome}</strong>`);
                        }
                        if (tal.coordenadas_poligono) {
                            try {
                                const coords = JSON.parse(tal.coordenadas_poligono);
                                if (Array.isArray(coords) && coords.length > 0) {
                                    const latlngs = coords.map(c => [c.lat, c.lng]);
                                    L.polygon(latlngs, {
                                        color: '#65B741',
                                        fillColor: '#65B741',
                                        fillOpacity: 0.3,
                                        weight: 2
                                    }).addTo(map)
                                    .bindPopup(`<strong>Talhão: ${tal.nome}</strong>`);
                                }
                            } catch (e) {
                                console.error('Erro ao parsear coordenadas:', e);
                            }
                        }
                    });
                    
                    // Adicionar pés
                    data.pes.forEach(pe => {
                        if (pe.latitude && pe.longitude) {
                            L.marker([parseFloat(pe.latitude), parseFloat(pe.longitude)], { icon: peIcon })
                                .addTo(map)
                                .bindPopup(`<strong>Pé: ${pe.nome}</strong>`);
                        }
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar dados da propriedade:', error);
            }
        });
    }

});
</script>

<%- include ('partials/footer.ejs') %>