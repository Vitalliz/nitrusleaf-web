<%- include('partials/header.ejs') %>
<%- include('partials/navbar-user.ejs') %>
<main class="main-content">
    <%- include ('partials/navbar-lateral.ejs') %>
    <form action="/propriedades/new" method="POST">
<div class="container mt-5">
    <h1 id="titulo">Cadastrar</h1>
    <div class="card mt-2" id="form-bg">
        <div class="card-body p-5">        
                <!-- Campos adicionais (class="d-none")-->
                <div id="camposAdicionais" class="mt-5">
                    <h4 id="titulo">Cadastro de Propriedade</h4>
                    <!-- Endereço -->  
                    <div class="row">
                        <div class="form-group col-md-6 m-3">
                            <label for="nome" class="form-label">Nome propriedade</label>
                            <input type="text" class="form-control" id="nome" name="nome" placeholder="Insira o nome da propriedade">
                        </div>
                        <div class="form-group col-md-5 m-3">
                            <label for="cep" class="form-label">CEP</label>
                            <input type="text" class="form-control" id="cep" name="cep" placeholder="Insira o CEP da propriedade">
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-8 m-3">
                            <label for="logradouro" class="form-label">Logradouro</label>
                            <input type="text" class="form-control" id="logradouro" name="logradouro" placeholder="Insira o logradouro da propriedade">
                        </div>
                        <div class="form-group col-md-3 m-3">
                            <label for="numero" class="form-label">Número</label>
                            <input type="text" class="form-control" id="numero" name="numero" placeholder="Insira o número ">
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group col-md-6  m-3">
                            <label for="bairro" class="form-label">Bairro</label>
                            <input type="text" class="form-control" id="bairro" name="bairro" placeholder="Insira o bairro da propriedade">
                        </div>
                        <div class="form-group col-md-5 m-3">
                            <label for="cidade" class="form-label">Cidade</label>
                            <input type="text" class="form-control" id="cidade" name="cidade" placeholder="Insira o cidade da propriedade">
                        </div>
                    </div>
                
                    <!-- Campos ocultos para coordenadas -->
                    <input type="hidden" id="latitude" name="latitude">
                    <input type="hidden" id="longitude" name="longitude">

                    <!-- Mapa para selecionar localização -->
                    <div class="row m-3">
                        <div class="form-group col-12">
                            <label class="form-label">Localização da Propriedade</label>
                            <div style="background: white; border: 2px solid #F2C48D; border-radius: 15px; padding: 15px; margin-top: 10px;">
                                <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button type="button" id="btn-marcar-ponto" class="btn-map-action" style="background: #65B741; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                        Marcar Ponto
                                    </button>
                                    <button type="button" id="btn-limpar" class="btn-map-action" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                        Limpar
                                    </button>
                                </div>
                                <div id="map" style="width: 100%; height: 400px; border-radius: 10px;"></div>
                            </div>
                        </div>
                    </div>

                <!-- Botão para cadastrar -->
                 <div class="container  my-2">
                    <button type="submit" class="btn pt-2 mt-3" style="padding-inline: 7rem;" id="btn-entrar">Cadastrar</button>
                </div>
            </div>
            </form>

            <!-- TABELA DE DADOS DAS PROPRIEDADES CADASTRADAS -->
            <div class="card my-4" id="form-bg-claro">
                <div class="card-body">
                    <table class="tabe">
                        <thead id="thead">
                            <th class="fonte" id="thead">Nome Propriedade</th>
                            <th class="fonte" id="thead">Rua</th>
                            <th class="fonte" id="thead">Bairro</th>
                            <th class="fonte" id="thead">Cidade</th>
                            <th class="fonte" id="thead">Editar</th>
                        </thead>
                        <tbody>
                            <% Propriedades.forEach(prop => { %>
                            <tr class="tb">
                            <td class="fonte" id="tabodyp"><%= prop.nome%></td>
                            <td class="fonte" id="tabodyp"><%= prop.logradouro%> Nº<%= prop.numero%></td>
                            <td class="fonte" id="tabodyp"><%= prop.bairro%></td>
                            <td class="fonte" id="tabodyp"><%= prop.cidade%></td>
                            <td class="fonte" id="tabodyp">
                                <a href="/propriedades/edit/<%= prop.id_propriedade %>"><img src="/imgs/btn-editar.svg" alt=""></a>
                            </td>
                            </tr>
                            <% }) %>
                        </tbody>
                        </table>
                </div>
            </div>

            <hr>
            <div class="d-flex justify-content-center">
                <h6><a href="/home">Voltar ao Início</a></h6>
            </div>
        </div>
    </div>
</div>
</main>
<%- include('partials/footer.ejs') %>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Inicializa mapa
    const map = L.map('map').setView([-24.7150037, -47.9281331], 15);

    // Adiciona layer Satelite da ESRI
    const satelite = L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        { attribution: 'Tiles © Esri' }
    );

    // Adiciona layer OpenStreetMap
    const osm = L.tileLayer(
        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        { attribution: '© OpenStreetMap' }
    );

    satelite.addTo(map);

    // Controle para alternar mapa/satelite
    L.control.layers({
        "Satelite": satelite,
        "Mapa": osm
    }).addTo(map);

    let marker = null;
    let isDrawing = false;

    // Botão marcar ponto
    document.getElementById('btn-marcar-ponto').addEventListener('click', function() {
        isDrawing = true;
        map.once('click', function(e) {
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker(e.latlng, { draggable: true }).addTo(map);
            document.getElementById('latitude').value = e.latlng.lat;
            document.getElementById('longitude').value = e.latlng.lng;
            
            marker.on('dragend', function(ev) {
                const pos = ev.target.getLatLng();
                document.getElementById('latitude').value = pos.lat;
                document.getElementById('longitude').value = pos.lng;
            });
            isDrawing = false;
        });
    });

    // Botão limpar
    document.getElementById('btn-limpar').addEventListener('click', function() {
        if (marker) {
            map.removeLayer(marker);
            marker = null;
        }
        document.getElementById('latitude').value = '';
        document.getElementById('longitude').value = '';
    });

    // Validação do formulário
    document.querySelector('form').addEventListener('submit', function(e) {
        const latitude = document.getElementById('latitude').value;
        const longitude = document.getElementById('longitude').value;
        
        // Coordenadas são opcionais, então não bloqueamos o envio
        // Mas podemos avisar se não foram preenchidas
        if (!latitude || !longitude) {
            if (!confirm('Nenhuma localização foi marcada no mapa. Deseja continuar mesmo assim?')) {
                e.preventDefault();
                return false;
            }
        }
    });
});
</script>

<style>
.btn-map-action:hover {
    opacity: 0.9;
    transform: translateY(-1px);
    transition: all 0.2s;
}
</style>
