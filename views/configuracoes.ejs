<%- include('partials/header.ejs') %>
<%- include('partials/navbar-user.ejs') %>

<main class="main-content settings-page">
  <%- include('partials/navbar-lateral.ejs') %>
  <section class="settings-container">
    <header class="settings-header">
      <h1>Configurações da Conta</h1>
      <p>Gerencie seus dados pessoais, propriedades e preferências de segurança.</p>
    </header>

    <% const temPropriedade = !!propriedade; %>
    <% const caminhoFoto = usuario && usuario.foto_perfil ? usuario.foto_perfil : null; %>

    <div class="settings-card">
      <details class="settings-section">
        <summary class="settings-summary">
          <span>Dados Pessoais</span>
          <span class="summary-icon"></span>
        </summary>
        <div class="settings-content">
          <form action="/configuracoes/update" method="post" enctype="multipart/form-data" class="settings-form">
            <div class="avatar-field">
              <div class="avatar-preview">
                <% if (caminhoFoto) { %>
                  <img src="<%= caminhoFoto %>" alt="Foto de perfil" />
                <% } else { %>
                  <span class="avatar-placeholder">+</span>
                <% } %>
              </div>
              <label class="button-outlined" for="foto_perfil">Escolher imagem</label>
              <input type="file" id="foto_perfil" name="foto_perfil" accept="image/*">
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label for="nome">Nome</label>
                <input type="text" id="nome" name="nome" value="<%= usuario ? usuario.nome : '' %>" required>
              </div>
              <div class="form-group">
                <label for="sobrenome">Sobrenome</label>
                <input type="text" id="sobrenome" name="sobrenome" value="<%= usuario ? usuario.sobrenome : '' %>" required>
              </div>
              <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" value="<%= usuario ? usuario.email : '' %>" required>
              </div>
              <div class="form-group">
                <label for="telefone">Telefone</label>
                <input type="text" id="telefone" name="telefone" value="<%= usuario ? usuario.telefone || '' : '' %>">
              </div>
              <div class="form-group">
                <label for="celular">Celular</label>
                <input type="text" id="celular" name="celular" value="<%= usuario ? usuario.celular || '' : '' %>">
              </div>
              <div class="form-group">
                <label for="tipo_pessoa">Tipo de pessoa</label>
                <select id="tipo_pessoa" name="tipo_pessoa">
                  <option value="fisica" <%= usuario && usuario.tipo_pessoa === 'fisica' ? 'selected' : '' %>>Pessoa Física</option>
                  <option value="juridica" <%= usuario && usuario.tipo_pessoa === 'juridica' ? 'selected' : '' %>>Pessoa Jurídica</option>
                </select>
              </div>
              <div class="form-group">
                <label for="cpf">CPF</label>
                <input type="text" id="cpf" name="cpf" value="<%= usuario ? usuario.cpf || '' : '' %>">
              </div>
              <div class="form-group">
                <label for="cnpj">CNPJ</label>
                <input type="text" id="cnpj" name="cnpj" value="<%= usuario ? usuario.cnpj || '' : '' %>">
              </div>
              <div class="form-group">
                <label for="nome_fantasia">Rua</label>
                <input type="text" id="nome_fantasia" name="nome_fantasia" value="<%= usuario ? usuario.nome_fantasia || '' : '' %>">
              </div>
              <div class="form-group">
                <label for="cep">CEP</label>
                <input type="text" id="cep" name="cep" value="<%= usuario ? usuario.cep || '' : '' %>">
              </div>
              <div class="form-group">
                <label for="logradouro">Logradouro</label>
                <input type="text" id="logradouro" name="logradouro" value="<%= usuario ? usuario.logradouro || '' : '' %>">
              </div>
              <div class="form-group">
                <label for="numero">Número</label>
                <input type="text" id="numero" name="numero" value="<%= usuario ? usuario.numero || '' : '' %>">
              </div>
              <div class="form-group">
                <label for="bairro">Bairro</label>
                <input type="text" id="bairro" name="bairro" value="<%= usuario ? usuario.bairro || '' : '' %>">
              </div>
              <div class="form-group">
                <label for="cidade">Cidade</label>
                <input type="text" id="cidade" name="cidade" value="<%= usuario ? usuario.cidade || '' : '' %>">
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="button-primary">Salvar alterações</button>
            </div>
          </form>
        </div>
      </details>

      <details class="settings-section">
        <summary class="settings-summary">
          <span><%= temPropriedade ? 'Dados da Propriedade' : 'Cadastrar Propriedade' %></span>
          <span class="summary-icon"></span>
        </summary>
        <div class="settings-content">
          <form action="/configuracoes/propriedade" method="post" class="settings-form">
            <% if (temPropriedade) { %>
              <input type="hidden" name="id_propriedade" value="<%= propriedade.id_propriedade %>">
            <% } %>
            <div class="form-grid">
              <div class="form-group">
                <label for="nome_propriedade">Nome da propriedade</label>
                <input type="text" id="nome_propriedade" name="nome" value="<%= temPropriedade ? propriedade.nome : '' %>" required>
              </div>
              <div class="form-group">
                <label for="cep_propriedade">CEP</label>
                <input type="text" id="cep_propriedade" name="cep" value="<%= temPropriedade ? propriedade.cep || '' : '' %>">
              </div>
              <div class="form-group">
                <label for="logradouro_propriedade">Logradouro</label>
                <input type="text" id="logradouro_propriedade" name="logradouro" value="<%= temPropriedade ? propriedade.logradouro || '' : '' %>">
              </div>
              <div class="form-group">
                <label for="numero_propriedade">Número</label>
                <input type="text" id="numero_propriedade" name="numero" value="<%= temPropriedade ? propriedade.numero || '' : '' %>">
              </div>
              <div class="form-group">
                <label for="bairro_propriedade">Bairro</label>
                <input type="text" id="bairro_propriedade" name="bairro" value="<%= temPropriedade ? propriedade.bairro || '' : '' %>">
              </div>
              <div class="form-group">
                <label for="cidade_propriedade">Cidade</label>
                <input type="text" id="cidade_propriedade" name="cidade" value="<%= temPropriedade ? propriedade.cidade || '' : '' %>">
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="button-primary"><%= temPropriedade ? 'Atualizar propriedade' : 'Cadastrar propriedade' %></button>
            </div>
            <% if (!temPropriedade) { %>
              <p class="section-hint">Você ainda não possui uma propriedade cadastrada. Preencha os dados para iniciar o acompanhamento.</p>
            <% } %>
          </form>
        </div>
      </details>

      <details class="settings-section">
        <summary class="settings-summary">
          <span>Segurança</span>
          <span class="summary-icon"></span>
        </summary>
        <div class="settings-content">
          <div class="settings-stack">
            <form action="/configuracoes/change-password" method="post" class="settings-form stack-item">
              <h3>Trocar senha</h3>
              <div class="form-grid">
                <div class="form-group">
                  <label for="senha_atual">Senha atual</label>
                  <input type="password" id="senha_atual" name="senha_atual" required>
                </div>
                <div class="form-group">
                  <label for="nova_senha">Nova senha</label>
                  <input type="password" id="nova_senha" name="nova_senha" required>
                </div>
                <div class="form-group">
                  <label for="confirmar_senha">Confirmar nova senha</label>
                  <input type="password" id="confirmar_senha" name="confirmar_senha" required>
                </div>
              </div>
              <div class="form-actions">
                <button type="submit" class="button-primary">Atualizar senha</button>
              </div>
            </form>

            <form action="/configuracoes/delete-account" method="post" class="settings-form stack-item">
              <h3>Apagar conta</h3>
              <p class="section-hint">Ao excluir sua conta, todos os dados vinculados serão removidos permanentemente.</p>
              <div class="form-group">
                <label for="senha_confirmacao">Confirme digitando sua senha</label>
                <input type="password" id="senha_confirmacao" name="senha_confirmacao" required>
              </div>
              <div class="form-actions">
                <button type="submit" class="button-danger">Apagar conta</button>
              </div>
            </form>
          </div>
        </div>
      </details>
    </div>
  </section>
</main>

<%- include('partials/footer.ejs') %>
