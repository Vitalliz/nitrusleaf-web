<%- include('partials/header.ejs') %>
<%- include('partials/navbar-user.ejs') %>
<main class="main-content home-dashboard">
    <%- include ('partials/navbar-lateral.ejs') %>
    <section class="dashboard-container">
        <header class="dashboard-header">
            <div style="display: flex; align-items: center; gap: 16px;">
                <a href="/talhoes" style="text-decoration: none; display: inline-flex; align-items: center; background: #65B741; color: white; padding: 12px 20px; border-radius: 12px; font-weight: 600; font-size: 16px; gap: 8px;">
                    <img src="/imgs/back.svg" alt="Voltar" style="width: 24px; height: 24px; filter: brightness(0) invert(1);">
                    Voltar
                </a>
                <h1 style="margin: 0; font-size: 28px; font-weight: 700; color: #351102;">Adicionar Talhão</h1>
            </div>
        </header>

        <section class="analysis-section">
            <div class="analysis-card" style="margin-bottom: 24px;">
                <div class="card-body">
                    <form action="/talhoes/new" method="POST" style="background: #fff; border-radius: 12px; padding: 20px;">
                        <input type="hidden" name="id_propriedade" value="<%= propriedadeSelecionada || '' %>">
                        
                        <div style="margin-bottom: 24px;">
                            <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #351102; font-size: 18px;">Propriedade</label>
                            <div style="padding: 16px; border: 2px solid #F2C48D; border-radius: 12px; background: #fff; font-size: 18px; color: #351102;">
                                <% const propriedadeAtual = propriedades.find(prop => prop.id_propriedade == propriedadeSelecionada); %>
                                <% if (propriedadeAtual) { %>
                                    <%= propriedadeAtual.nome %>
                                <% } else { %>
                                    Propriedade não encontrada
                                <% } %>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 24px;">
                            <label for="id_alqueire" style="display: block; margin-bottom: 12px; font-weight: 600; color: #351102; font-size: 18px;">Alqueire (opcional)</label>
                            <select id="id_alqueire" name="id_alqueire" style="width: 100%; padding: 16px; border: 2px solid #F2C48D; border-radius: 12px; font-size: 18px; background: #fff; color: #351102;">
                                <option value="">Selecione um alqueire (opcional)</option>
                                <% if (alqueires && alqueires.length > 0) { %>
                                    <% alqueires.forEach(alq => { %>
                                        <option value="<%= alq.id_alqueire %>"><%= alq.nome %></option>
                                    <% }) %>
                                <% } %>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 24px;">
                            <label for="nome" style="display: block; margin-bottom: 12px; font-weight: 600; color: #351102; font-size: 18px;">Nome do Talhão</label>
                            <input type="text" id="nome" name="nome" placeholder="Insira o nome do talhão" required 
                                style="width: 100%; padding: 16px; border: 2px solid #F2C48D; border-radius: 12px; font-size: 18px; background: #fff; color: #351102;">
                        </div>
                        
                        <div style="margin-bottom: 24px;">
                            <label for="especie_fruta" style="display: block; margin-bottom: 12px; font-weight: 600; color: #351102; font-size: 18px;">Espécie Plantada</label>
                            <input type="text" id="especie_fruta" name="especie_fruta" placeholder="Insira a espécie de fruta" required 
                                style="width: 100%; padding: 16px; border: 2px solid #F2C48D; border-radius: 12px; font-size: 18px; background: #fff; color: #351102;">
                        </div>
                        
                        <!-- Campos ocultos para coordenadas -->
                        <input type="hidden" id="latitude" name="latitude">
                        <input type="hidden" id="longitude" name="longitude">
                        <input type="hidden" id="coordenadas_poligono" name="coordenadas_poligono">
                        
                        <!-- Mapa para selecionar localização -->
                        <div style="margin-bottom: 24px;">
                            <label style="display: block; margin-bottom: 12px; font-weight: 600; color: #351102; font-size: 18px;">
                                Localização do Talhão
                                <span style="font-size: 16px; font-weight: 400; color: #666;">(Marque um ponto ou desenhe um polígono no mapa)</span>
                            </label>
                            <div style="background: white; border: 2px solid #F2C48D; border-radius: 15px; padding: 20px;">
                                <div style="margin-bottom: 15px; display: flex; gap: 12px; flex-wrap: wrap;">
                                    <button type="button" id="btn-marcar-ponto" class="btn-map-action" style="background: #65B741; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">
                                        Marcar Ponto
                                    </button>
                                    <button type="button" id="btn-desenhar-poligono" class="btn-map-action" style="background: #0284E1; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">
                                        Desenhar Polígono
                                    </button>
                                    <button type="button" id="btn-limpar" class="btn-map-action" style="background: #dc3545; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">
                                        Limpar
                                    </button>
                                </div>
                                <div id="map" style="width: 100%; height: 450px; border-radius: 12px;"></div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 32px;">
                            <button type="submit" style="background: #65B741; color: #fff; font-weight: 600; border-radius: 12px; padding: 16px 48px; border: none; cursor: pointer; font-size: 18px;">
                                Cadastrar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    </section>
</main>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Plugin para desenho de polígonos/edição -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css"/>
<script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Determinar centro inicial do mapa baseado na propriedade
    let mapCenter = [-24.7150037, -47.9281331];
    let mapZoom = 15;
    
    <% if (propriedades && propriedades.length > 0) { %>
        <% const propriedadeAtual = propriedades.find(prop => prop.id_propriedade == propriedadeSelecionada); %>
        <% if (propriedadeAtual && propriedadeAtual.latitude && propriedadeAtual.longitude) { %>
            mapCenter = [parseFloat(<%= propriedadeAtual.latitude %>), parseFloat(<%= propriedadeAtual.longitude %>)];
        <% } %>
    <% } %>
    
    // Dados do servidor para mostrar no mapa
    const propriedadesData = <%- JSON.stringify(propriedades) %>;
    const alqueiresData = <%- JSON.stringify(alqueires) %>;
    const propriedadeSelecionadaId = '<%= propriedadeSelecionada || "" %>';
    
    // Inicializar mapa
    const map = L.map('map').setView(mapCenter, mapZoom);
    
    // Adiciona layer Satelite da ESRI
    const satelite = L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        { attribution: 'Tiles © Esri' }
    );
    
    // Adiciona layer OpenStreetMap
    const osm = L.tileLayer(
        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        { attribution: '© OpenStreetMap' }
    );
    
    satelite.addTo(map);
    
    // Controle para alternar mapa/satelite
    L.control.layers({
        "Satelite": satelite,
        "Mapa": osm
    }).addTo(map);
    
    // Mostrar propriedade selecionada no mapa
    if (propriedadeSelecionadaId) {
        const propriedadeAtual = propriedadesData.find(p => p.id_propriedade == propriedadeSelecionadaId);
        if (propriedadeAtual && propriedadeAtual.latitude && propriedadeAtual.longitude) {
            L.marker([parseFloat(propriedadeAtual.latitude), parseFloat(propriedadeAtual.longitude)], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34]
                })
            }).addTo(map).bindPopup(`<strong>Propriedade: ${propriedadeAtual.nome}</strong>`);
        }
    }
    
    // Mostrar alqueires já cadastrados
    alqueiresData.forEach(alq => {
        if (alq.latitude && alq.longitude) {
            L.marker([parseFloat(alq.latitude), parseFloat(alq.longitude)], {
                icon: L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34]
                })
            }).addTo(map).bindPopup(`<strong>Alqueire: ${alq.nome}</strong>`);
        }
        if (alq.coordenadas_poligono) {
            try {
                const coords = JSON.parse(alq.coordenadas_poligono);
                if (Array.isArray(coords) && coords.length > 0) {
                    const latlngs = coords.map(c => [c.lat, c.lng]);
                    L.polygon(latlngs, {
                        color: '#0284E1',
                        fillColor: '#0284E1',
                        fillOpacity: 0.2,
                        weight: 2
                    }).addTo(map).bindPopup(`<strong>Alqueire: ${alq.nome}</strong>`);
                }
            } catch (e) {
                console.error('Erro ao parsear coordenadas do alqueire:', e);
            }
        }
    });
    
    let marker = null;
    let polygon = null;
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);
    
    // Configurar ferramenta de desenho
    const drawControl = new L.Control.Draw({
        edit: { featureGroup: drawnItems },
        draw: {
            polygon: true,
            polyline: false,
            circle: false,
            rectangle: false,
            marker: true
        }
    });
    
    // Quando um polígono ou marcador é criado
    map.on(L.Draw.Event.CREATED, function (event) {
        const layer = event.layer;
        drawnItems.addLayer(layer);
        
        if (event.layerType === 'polygon') {
            if (polygon) {
                drawnItems.removeLayer(polygon);
            }
            polygon = layer;
            const coords = layer.getLatLngs()[0].map(p => ({
                lat: p.lat,
                lng: p.lng
            }));
            
            // Calcular centro do polígono
            const bounds = layer.getBounds();
            const center = bounds.getCenter();
            
            document.getElementById('latitude').value = center.lat;
            document.getElementById('longitude').value = center.lng;
            document.getElementById('coordenadas_poligono').value = JSON.stringify(coords);
        } else if (event.layerType === 'marker') {
            if (marker) {
                drawnItems.removeLayer(marker);
            }
            if (polygon) {
                drawnItems.removeLayer(polygon);
                polygon = null;
                document.getElementById('coordenadas_poligono').value = '';
            }
            marker = layer;
            const position = layer.getLatLng();
            document.getElementById('latitude').value = position.lat;
            document.getElementById('longitude').value = position.lng;
            document.getElementById('coordenadas_poligono').value = '';
            
            marker.on('dragend', function(ev) {
                const pos = ev.target.getLatLng();
                document.getElementById('latitude').value = pos.lat;
                document.getElementById('longitude').value = pos.lng;
            });
        }
    });
    
    // Botão marcar ponto
    document.getElementById('btn-marcar-ponto').addEventListener('click', function() {
        if (polygon) {
            drawnItems.removeLayer(polygon);
            polygon = null;
            document.getElementById('coordenadas_poligono').value = '';
        }
        // Ativar modo de desenho de marcador
        if (drawControl._toolbars && drawControl._toolbars.draw && drawControl._toolbars.draw._modes && drawControl._toolbars.draw._modes.marker) {
            drawControl._toolbars.draw._modes.marker.handler.enable();
        } else {
            // Fallback: criar marcador ao clicar no mapa
            map.once('click', function(e) {
                if (marker) {
                    drawnItems.removeLayer(marker);
                }
                marker = L.marker(e.latlng, { draggable: true });
                drawnItems.addLayer(marker);
                document.getElementById('latitude').value = e.latlng.lat;
                document.getElementById('longitude').value = e.latlng.lng;
                document.getElementById('coordenadas_poligono').value = '';
                
                marker.on('dragend', function(ev) {
                    const pos = ev.target.getLatLng();
                    document.getElementById('latitude').value = pos.lat;
                    document.getElementById('longitude').value = pos.lng;
                });
            });
        }
    });
    
    // Botão desenhar polígono
    document.getElementById('btn-desenhar-poligono').addEventListener('click', function() {
        if (marker) {
            drawnItems.removeLayer(marker);
            marker = null;
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
        }
        // Ativar modo de desenho de polígono
        if (drawControl._toolbars && drawControl._toolbars.draw && drawControl._toolbars.draw._modes && drawControl._toolbars.draw._modes.polygon) {
            drawControl._toolbars.draw._modes.polygon.handler.enable();
        }
    });
    
    // Botão limpar
    document.getElementById('btn-limpar').addEventListener('click', function() {
        drawnItems.clearLayers();
        marker = null;
        polygon = null;
        document.getElementById('latitude').value = '';
        document.getElementById('longitude').value = '';
        document.getElementById('coordenadas_poligono').value = '';
    });
    
    // Adicionar controle de desenho ao mapa
    map.addControl(drawControl);
});
</script>

<style>
.btn-map-action:hover {
    opacity: 0.9;
    transform: translateY(-1px);
    transition: all 0.2s;
}
</style>

<%- include('partials/footer.ejs') %>