<%- include ('partials/header.ejs') %>
<%- include ('partials/navbar-user.ejs') %>

<main class="main-content home-dashboard">
  <%- include ('partials/navbar-lateral.ejs') %>
  <section class="dashboard-container">
    <header class="dashboard-header">
      <h1>Início</h1>
    </header>

    <section class="upload-card">
      <div class="upload-card-content">
        <a href="/home/selecionar-pe" class="primary-upload-button">
          <span class="upload-icon">+</span>
          Escanear Imagem
        </a>
        <p class="upload-note">*Certifique-se que a folha esteja visível</p>
        <p class="upload-status"><%= mensagemStatus %></p>
      </div>
    </section>

    <section class="analysis-section">
      <div class="analysis-section-header">
        <h2>Análises Gerais</h2>
        <div class="property-select">
          <label for="propriedades">Propriedade</label>
          <div class="select-wrapper">
            <% if (Propriedades && Propriedades.length > 0) { %>
              <select id="propriedades" class="property-dropdown">
                <% Propriedades.forEach(prop => { %>
                  <option value="<%= prop.id_propriedade %>" <%= propriedadeSelecionada == prop.id_propriedade ? 'selected' : '' %>><%= prop.nome %></option>
                <% }) %>
              </select>
            <% } else { %>
              <select id="propriedades" class="property-dropdown" disabled>
                <option>Nenhuma propriedade cadastrada</option>
              </select>
            <% } %>
          </div>
        </div>
      </div>
      <div class="analysis-grid">
        <article class="analysis-card">
          <header class="card-header">
            <h3>Ocorrências totais de deficiências em %</h3>
          </header>
          <div class="card-body">
            <canvas id="chart-deficiencias"></canvas>
            <div id="deficiencias-empty" class="empty-state hidden">Nenhuma análise feita recentemente</div>
            <ul class="analysis-legend">
              <li>
                <span class="legend-color cobre"></span>
                <div>
                  <strong><%= resumoDeficiencias.percentuais.cobre %>%</strong>
                  <span>Cobre</span>
                </div>
              </li>
              <li>
                <span class="legend-color manganes"></span>
                <div>
                  <strong><%= resumoDeficiencias.percentuais.manganes %>%</strong>
                  <span>Manganês</span>
                </div>
              </li>
              <li>
                <span class="legend-color outros"></span>
                <div>
                  <strong><%= resumoDeficiencias.percentuais.outros %>%</strong>
                  <span>Adversos</span>
                </div>
              </li>
            </ul>
            <p class="analysis-total"><strong><%= totalPesAnalisados %></strong> pés analisados</p>
          </div>
          <div class="card-footer">
            <a href="/analises/ocorrencias" class="card-action">Detalhar</a>
          </div>
        </article>

        <article class="analysis-card">
          <header class="card-header">
            <h3>Deficiência por Talhão</h3>
            <span class="card-subtitle">Últimos três talhões</span>
          </header>
          <div class="card-body">
            <canvas id="chart-talhao"></canvas>
            <div id="talhoes-empty" class="empty-state hidden"><%= talhoesMensagem || 'Nenhum dado disponível' %></div>
          </div>
          <div class="card-footer">
            <a href="/analises/deficiencia-talhao" class="card-action">Detalhar</a>
          </div>
        </article>

        <article class="analysis-card">
          <header class="card-header">
            <h3>Evolução das Deficiências (%)</h3>
            <span class="card-subtitle">Últimas quatro análises</span>
          </header>
          <div class="card-body">
            <canvas id="chart-evolucao"></canvas>
            <div id="evolucao-empty" class="empty-state hidden"><%= evolucaoMensagem || 'Nenhum dado feito nos últimos meses' %></div>
          </div>
          <div class="card-footer">
            <a href="/analises/evolucao" class="card-action">Detalhar</a>
          </div>
        </article>
      </div>
    </section>
  </section>
</main>

<%- include ('partials/footer.ejs') %>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  window.resumoDeficiencias = <%- JSON.stringify(resumoDeficiencias) %>;
  window.totalPesAnalisados = <%- JSON.stringify(totalPesAnalisados) %>;
  window.talhoesComparacao = <%- JSON.stringify(talhoesComparacao) %>;
  window.talhoesMensagem = <%- JSON.stringify(talhoesMensagem) %>;
  window.evolucaoAnalises = <%- JSON.stringify(evolucaoAnalises) %>;
  window.evolucaoMensagem = <%- JSON.stringify(evolucaoMensagem) %>;
  window.maxTalhaoValor = <%- JSON.stringify(maxTalhaoValor || 0) %>;
</script>
<script src="/js/home-charts.js"></script>
<script src="/js/propselecionada.js"></script>
<script src="/script/upload.js"></script>
