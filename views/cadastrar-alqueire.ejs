<%- include ('partials/header.ejs') %>
<%- include('partials/navbar-user.ejs') %>
<main class="main-content">
    <%- include ('partials/navbar-lateral.ejs') %>  
    <div class="container cont">     
        <div class="container">
            <div class="d-flex align-items-center justify-content-between mt-2" id="hist">
                <h2 class="align-self-end m-0 p-0 fonte titulo1">Cadastrar Alqueire</h2>
                <div id="options-container">
                    <select id="propriedades" class="options" name="id_propriedade" required>
                        <% propriedades.forEach(prop => {%>
                            <option value="<%= prop.id_propriedade%>" <%= propriedadeSelecionada == prop.id_propriedade ? 'selected' : '' %>><%= prop.nome%></option>
                        <%})%>
                    </select>
                    <img src="/imgs/seta-prop.svg" alt="Seta" class="menu-arrowp" id="setajs"/>
                </div>
            </div>
            <img src="/imgs/linha.png" alt="" id="voltar-linha" class="p-0 mt-0" />
        </div>
        
        <div class="container pt-3">
            <form id="form-cadastro-alqueire" action="/alqueires/new" method="POST">
                <input type="hidden" id="id_propriedade" name="id_propriedade" value="<%= propriedadeSelecionada %>">
                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">
                <input type="hidden" id="coordenadas_poligono" name="coordenadas_poligono">
                
                <div class="form-row" style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="nome" style="display: block; margin-bottom: 8px; font-weight: 600; color: #351102;">Nome do Alqueire</label>
                        <input type="text" id="nome" name="nome" class="form-control" required 
                               style="width: 100%; padding: 10px; border: 2px solid var(--verde-escuro); border-radius: 8px; font-size: 15px;">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="area_total" style="display: block; margin-bottom: 8px; font-weight: 600; color: #351102;">Área Total (hectares)</label>
                        <input type="number" id="area_total" name="area_total" step="0.01" class="form-control"
                               style="width: 100%; padding: 10px; border: 2px solid var(--verde-escuro); border-radius: 8px; font-size: 15px;">
                    </div>
                </div>
                
                <div class="map-section" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #351102;">
                        Localização do Alqueire
                        <span style="font-size: 13px; font-weight: 400; color: #666;">(Marque um ponto ou desenhe um polígono no mapa)</span>
                    </label>
                    
                    <div style="background: white; border: 2px solid var(--verde-escuro); border-radius: 15px; padding: 15px;">
                        <div style="margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button type="button" id="btn-marcar-ponto" class="btn-map-action" style="background: #65B741; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                Marcar Ponto
                            </button>
                            <button type="button" id="btn-desenhar-poligono" class="btn-map-action" style="background: #0284E1; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                Desenhar Polígono
                            </button>
                            <button type="button" id="btn-limpar" class="btn-map-action" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                Limpar
                            </button>
                        </div>
                        <div id="map" style="width: 100%; height: 500px; border-radius: 10px;"></div>
                    </div>
                </div>
                
                <div class="form-actions" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <a href="/historico" class="btn-cancel" style="background: #6c757d; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 600;">
                        Cancelar
                    </a>
                    <button type="submit" class="btn-submit" style="background: #65B741; color: white; padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer;">
                        Cadastrar Alqueire
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>

<script src="https://maps.googleapis.com/maps/api/js?key=<%= googleMapsApiKey %>&libraries=drawing,geometry"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    let map;
    let marker = null;
    let polygon = null;
    let drawingManager;
    const propriedadesSelect = document.getElementById('propriedades');
    
    // Inicializar o mapa
    function initMap() {
        const defaultCenter = { lat: -24.715003701623697, lng: -47.92813313180629 };
        
        <% if (propriedade && propriedade.latitude && propriedade.longitude) { %>
        const propriedadeCenter = {
            lat: parseFloat(<%= propriedade.latitude %>),
            lng: parseFloat(<%= propriedade.longitude %>)
        };
        <% } %>
        
        map = new google.maps.Map(document.getElementById("map"), {
            center: <% if (propriedade && propriedade.latitude && propriedade.longitude) { %>propriedadeCenter<% } else { %>defaultCenter<% } %>,
            zoom: 15,
            mapTypeId: 'satellite',
            mapTypeControl: true,
            streetViewControl: true,
            fullscreenControl: true
        });
        
        // Configurar Drawing Manager
        drawingManager = new google.maps.drawing.DrawingManager({
            drawingMode: null,
            drawingControl: false,
            markerOptions: {
                draggable: true
            },
            polygonOptions: {
                fillColor: '#65B741',
                fillOpacity: 0.35,
                strokeWeight: 2,
                strokeColor: '#65B741',
                clickable: false,
                editable: true,
                zIndex: 1
            }
        });
        
        drawingManager.setMap(map);
        
        // Listener para quando um polígono é criado
        google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
            if (event.type === 'polygon') {
                if (polygon) {
                    polygon.setMap(null);
                }
                polygon = event.overlay;
                const paths = polygon.getPath();
                const coordinates = [];
                
                paths.forEach(function(latLng) {
                    coordinates.push({
                        lat: latLng.lat(),
                        lng: latLng.lng()
                    });
                });
                
                // Calcular centro do polígono para latitude/longitude
                const bounds = new google.maps.LatLngBounds();
                paths.forEach(function(latLng) {
                    bounds.extend(latLng);
                });
                const center = bounds.getCenter();
                
                document.getElementById('latitude').value = center.lat();
                document.getElementById('longitude').value = center.lng();
                document.getElementById('coordenadas_poligono').value = JSON.stringify(coordinates);
                
                drawingManager.setDrawingMode(null);
            } else if (event.type === 'marker') {
                if (marker) {
                    marker.setMap(null);
                }
                if (polygon) {
                    polygon.setMap(null);
                    polygon = null;
                }
                
                marker = event.overlay;
                const position = marker.getPosition();
                
                document.getElementById('latitude').value = position.lat();
                document.getElementById('longitude').value = position.lng();
                document.getElementById('coordenadas_poligono').value = '';
                
                marker.addListener('dragend', function() {
                    const pos = marker.getPosition();
                    document.getElementById('latitude').value = pos.lat();
                    document.getElementById('longitude').value = pos.lng();
                });
                
                drawingManager.setDrawingMode(null);
            }
        });
    }
    
    // Botão marcar ponto
    document.getElementById('btn-marcar-ponto').addEventListener('click', function() {
        if (polygon) {
            polygon.setMap(null);
            polygon = null;
            document.getElementById('coordenadas_poligono').value = '';
        }
        drawingManager.setDrawingMode(google.maps.drawing.OverlayType.MARKER);
    });
    
    // Botão desenhar polígono
    document.getElementById('btn-desenhar-poligono').addEventListener('click', function() {
        if (marker) {
            marker.setMap(null);
            marker = null;
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
        }
        drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON);
    });
    
    // Botão limpar
    document.getElementById('btn-limpar').addEventListener('click', function() {
        if (marker) {
            marker.setMap(null);
            marker = null;
        }
        if (polygon) {
            polygon.setMap(null);
            polygon = null;
        }
        document.getElementById('latitude').value = '';
        document.getElementById('longitude').value = '';
        document.getElementById('coordenadas_poligono').value = '';
        drawingManager.setDrawingMode(null);
    });
    
    // Mudança de propriedade
    propriedadesSelect.addEventListener('change', function() {
        document.getElementById('id_propriedade').value = this.value;
        // Recarregar página com nova propriedade selecionada
        window.location.href = `/alqueires/cadastrar?propriedade=${this.value}`;
    });
    
    // Validação do formulário
    document.getElementById('form-cadastro-alqueire').addEventListener('submit', function(e) {
        const latitude = document.getElementById('latitude').value;
        const longitude = document.getElementById('longitude').value;
        
        if (!latitude || !longitude) {
            e.preventDefault();
            alert('Por favor, marque a localização do alqueire no mapa antes de cadastrar.');
            return false;
        }
    });
    
    // Inicializar o mapa
    initMap();
});
</script>

<style>
.btn-map-action:hover {
    opacity: 0.9;
    transform: translateY(-1px);
    transition: all 0.2s;
}

.btn-cancel:hover {
    opacity: 0.9;
}

.btn-submit:hover {
    background: #5aa338 !important;
}
</style>

<%- include ('partials/footer.ejs') %>
